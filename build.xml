<?xml version="1.0"?>
<project name="IBPWorkbenchLauncher" default="build" basedir=".">
    
    <description>
        ANT build file for IBPWorkbenchLauncher.
        
        The following major targets are available:

        build      used to create a jar file that can be used in
                   production code. It compiles a clean, optimized version of
                   the classes in the framework and packages them in a JAR.
                   The core classes in the framework  and any classes in the
                   contrib directory are used. The examples and test classes
                   are excluded.
        
        The following minor targets provide more control over the compiling
        and packaging of classes, allowing for example a JAR file to be
        created containing the framework classes and the examples.

        clean      remove all the files generated by the compile targets. This
                   deletes the build directory which contains the compiled
                   classes along with any JAR files created.

        classes    compile the classes

        jar        packages all of the compiled classes in the build directory
                   into the JAR file.
    </description>

    <property name="project.artifactId" value="ibpworkbench_launcher" />
    <property name="project.version" value="1.0" />

    <!-- <property name="bin.dir" location="bin" /> -->
    <property name="src.dir" location="src" />
    <property name="build.dir" location="build" />
    <property name="jar.dir" location="jar" />
    <property name="lib.dir" location="lib" />
    
    <!-- The directory where the JRE, Tomcat and MySQL zip files are located. -->
    <property name="installers.dir" location="installers"/>
    <property name="jre.zip" location="${installers.dir}/jre.zip"/>
    <property name="tomcat.zip" location="${installers.dir}/tomcat.zip"/>
    <property name="tomcat.zip.expanded" value="apache-tomcat-7.0.34"/>
    <property name="mysql.zip" location="${installers.dir}/mysql-5.5.23-win32.zip"/>
    <property name="mysql.zip.expanded" value="mysql-5.5.23-win32"/>
    
    <!-- The directory where the MySQL and Tomcat configuration files are located. -->
    <property name="installers_conf.dir" location="installers_conf"/>
    <!-- <property name="webapps.dir" location="webapps"/> -->
    
    <!-- The directory where the tools (fieldbook, optimas, breeding view, etc...) are located -->
    <property name="tools.dir" location="tools"/>
    <!-- <property name="tools_conf.dir" location="tools_conf"/> -->
    
    <!-- The directory where initial files are located -->
    <property name="init_files.dir" location="init_files"/>
    
    <!-- The directory where the CWS documentation is located -->
    <property name="documentation.dir" location="documentation"/>
    
    <!-- The directory where the scripts for tutorial/demo purposes are located -->
    <property name="demo_scripts.dir" location="demo_scripts"/>
    
    <!-- Properties used by the "launch4j" task. -->
    <property name="launch4j.dir" location="launch4j"/>
    <property name="images.dir" location="images"/>
    <property name="launch4j.path" value="C:/Program Files/Launch4j/launch4jc.exe"/>
    
    <!-- The directory where Install4J files are located -->
    <property name="install4j.dir" location="install4j"/>
    
    <property name="dist.dir" value="C:/kevinWork/dist"/>
    <property name="nsis.dir" location="nsis"/>
    
    <!-- The location of the IBDB scripts and central database scripts -->
    <property name="IBDBScripts.dir" location="../IBDBScripts"/>
    <property name="crop.database.dir" location="crop_databases"/>
    
    <!-- The location of the NSIS executable -->
    <property name="makensis.path" value="C:/Program Files (x86)/NSIS/makensis.exe"/>
    
    <!-- MySQL related properties -->
    <property name="dist.mysqld.path" value="${dist.dir}/infrastructure/mysql/bin/mysqld.exe"/>
    <property name="mysql.port" value="13306"/>
    <property name="run_script.path" location="crop_databases/run_script.bat"/>
    <property name="stop_mysql_script.path" location="crop_databases/stop_mysql.bat"/>
    
    <!-- <property name="version" value="${project.version}" /> -->

    <!-- Location of the GCP projects. These are used to build the web apps -->
    <property name="gdms.dir" value="../GDMS"/>
    <property name="middleware.dir" value="../IBPMiddleware"/>
    <property name="study_browser.dir" location="../GermplasmStudyBrowser"/>
    <property name="workbench.dir" location="../ibpworkbench"/>
    
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${lib.dir}/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <!-- **********************************************************
         Classpath to be used when compiling project classes.
    ********************************************************** -->
    <path id="project.classpath">
        <fileset dir="${lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>
    
    <!-- **********************************************************
         Major targets for compiling and packaging the classes.
     ********************************************************** -->

    <target name="build" depends="clean,compile,jar,del-build-dir" description="Compile optimized versions for deployment">
        <echo>You can also run the "make_installer" target to create the distribution directory and the installer file.</echo>
    </target>
    
    <!-- *******************************************************************
         Minor targets to compile and package different sets of classes.
     ******************************************************************* -->

    <target name="clean" description="Remove all the compiled classes">
        <delete dir="${build.dir}" failonerror="false" />
        <delete file="${jar.dir}/${project.artifactId}.jar" failonerror="false" />
    </target>
    
    <target name="del-build-dir" description="Delete build directory">
        <delete dir="${build.dir}" failonerror="false" />
    </target>

    <target name="compile" description="Compile the classes">
        <mkdir dir="${build.dir}" />

        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="off" optimize="off" source="1.6" classpathref="project.classpath" includeantruntime="false">
            <include name="**" />
            <exclude name="test/**"/>
        </javac>
        
        <copy todir="${build.dir}">
            <fileset dir="${src.dir}/main/resources">
                <include name="**/*.xml"/>
                <include name="**/*.properties"/>
                <include name="**/*.txt"/>
                <include name="**/*.ico"/>
            </fileset>
        </copy>
    </target>

    <target name="jar" description="Package all of the classes in a JAR file">
        <mkdir dir="${jar.dir}"/>
        
        <jar jarfile="${jar.dir}/${project.artifactId}.jar">
            <manifest>
                <attribute name="Main-Class" value="org.generationcp.ibpworkbench.launcher.Launcher"/>
                <attribute name="Class-Path" value="."/>
                <attribute name="Premain-Class" value="org.springframework.instrument.InstrumentationSavingAgent"/>
            </manifest>
            <fileset dir="${build.dir}">
                <include name="**"/>
            </fileset>
            <!-- SWT -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/org.eclipse.swt.win32.win32.x86_3.6.2.v3659c.jar"/>
            <!-- Tomcat -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/bootstrap.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/tomcat-juli.jar"/>
            <!-- Spring -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/spring-instrument-3.1.1.RELEASE.jar"/>
            <!-- MySQL -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/mysql-connector-java-5.1.13-bin.jar"/>
            <!-- HTTP Client -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/httpclient-4.2.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/httpcore-4.2.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/httpmime-4.2.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/commons-codec-1.6.jar"/>
            <!-- Apache Commons -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/commons-lang3-3.1.jar"/>
            <!-- Logging -->
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/slf4j-api-1.6.4.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/logback-core-1.0.1.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/logback-classic-1.0.1.jar"/>
            <zipfileset excludes="META-INF/*.SF" src="${lib.dir}/commons-logging-1.1.1.jar"/>
        </jar>
    </target>
    
    <target name="copy-jars" depends="build">
        <copy todir="${dist.dir}">
            <fileset dir="${jar.dir}"/>
        </copy>
    </target>
    
    <target name="copy-launch4j" depends="build">
        <copy todir="${dist.dir}">
            <fileset dir="${launch4j.dir}"/>
        </copy>
    </target>
    
    <target name="copy-images" depends="build">
        <copy todir="${dist.dir}/images">
            <fileset dir="${images.dir}"/>
        </copy>
    </target>
    
    <target name="launch4j" depends="build, dist-mkdir, copy-jars, copy-images" description="Create an executable launcher">
        <exec dir="${dist.dir}" executable="${launch4j.path}">
            <arg value="launch4j.xml"/>
        </exec>
    </target>
    
    <target name="dist-mkdir">
        <mkdir dir="${dist.dir}"/>
    </target>
    
    <target name="unzip-jre">
        <unzip src="${jre.zip}" dest="${dist.dir}"/>
    </target>
    
    <target name="unzip-mysql">
        <unzip src="${mysql.zip}" dest="${dist.dir}"/>
        
        <mkdir dir="${dist.dir}/infrastructure"/>
        
        <move todir="${dist.dir}/infrastructure/mysql">
            <fileset dir="${dist.dir}/${mysql.zip.expanded}"/>
        </move>
        
        <move todir="${dist.dir}/data">
            <fileset dir="${dist.dir}/infrastructure/mysql/data"/>
        </move>
    </target>
    
    <target name="unzip-tomcat">
        <unzip src="${tomcat.zip}" dest="${dist.dir}"/>
        
        <mkdir dir="${dist.dir}/infrastructure"/>
        
        <move todir="${dist.dir}/infrastructure/tomcat">
            <fileset dir="${dist.dir}/${tomcat.zip.expanded}"/>
        </move>
        
        <!-- Delete the unnecessary Tomcat files -->
        <delete dir="${dist.dir}/infrastructure/tomcat/conf/Catalina/localhost" failonerror="no"/>
        <mkdir dir="${dist.dir}/infrastructure/tomcat/conf/Catalina/localhost"/>
        <delete dir="${dist.dir}/infrastructure/tomcat/webapps" failonerror="no"/>
        <mkdir dir="${dist.dir}/infrastructure/tomcat/webapps"/>
    </target>
    
    <target name="update-conf-files" description="Update the configuration files">
        <copy todir="${dist.dir}" overwrite="yes" verbose="yes">
            <fileset dir="${installers_conf.dir}"/>
        </copy>
    </target>
    
    <target name="copy-database-data" description="Copy database files to dist directory">
        <mkdir dir="${dist.dir}/crop_databases/central"/>
        <copy todir="${dist.dir}/crop_databases/central" overwrite="yes" verbose="yes">
            <fileset dir="${crop.database.dir}/central">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
        <copy todir="${dist.dir}/crop_databases/central_light" overwrite="yes" verbose="yes">
            <fileset dir="${crop.database.dir}/central_light">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
        <mkdir dir="${dist.dir}/crop_databases/local"/>
        <copy todir="${dist.dir}/crop_databases/local" overwrite="yes" verbose="yes">
            <fileset dir="${crop.database.dir}/local">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
        <mkdir dir="${dist.dir}/crop_databases/workbench"/>
        <copy todir="${dist.dir}/crop_databases/workbench" overwrite="yes" verbose="yes">
            <fileset dir="${crop.database.dir}/workbench">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
        <copy todir="${dist.dir}/crop_databases" overwrite="yes" verbose="yes">
            <fileset dir="${crop.database.dir}">
                <include name="*.bat"/>
            	<include name="*.sh"/>
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
    </target>
    
    <target name="copy-license" description="Copy license files to dist directory">
        <copy todir="${dist.dir}" overwrite="yes" verbose="yes">
            <fileset dir="${install4j.dir}">
                <include name="license**"/>
            </fileset>
        </copy>
    </target>
    
    <target name="build-webapps" description="Build webapps">
        <!--<ant antfile="${gdms.dir}/build.xml" dir="${gdms.dir}" inheritall="false"/>-->
        <ant antfile="${middleware.dir}/build.xml" dir="${middleware.dir}" inheritall="false"/>
        <ant antfile="${study_browser.dir}/build.xml" dir="${study_browser.dir}" inheritall="false"/>
        <ant antfile="${workbench.dir}/build.xml" dir="${workbench.dir}" inheritall="false"/>
    </target>
    
    <target name="copy-webapps" description="Copy webapps to Tomcat">
        <!-- Copy the web apps to tomcat -->
        <copy todir="${dist.dir}/infrastructure/tomcat/webapps" overwrite="yes" verbose="yes">
            <!--
        	<fileset dir="${gdms.dir}/target">
                <include name="*.war"/>
            </fileset>
            -->
            <fileset dir="${study_browser.dir}/target">
                <include name="*.war"/>
            </fileset>
            <fileset dir="${workbench.dir}/target">
                <include name="*.war"/>
            </fileset>
        </copy>
    </target>
    
    <target name="copy-tools" description="Copy tools">
        <copy todir="${dist.dir}/tools">
            <fileset dir="${tools.dir}">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
    </target>
    
    <target name="copy-init-files" description="Copy initial files">
        <copy todir="${dist.dir}" overwrite="true" verbose="true">
            <fileset dir="${init_files.dir}">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
    </target>
    
    <target name="copy-documentation" description="Copy documentation and sample files">
        <copy todir="${dist.dir}/documents" overwrite="true" verbose="true">
            <fileset dir="${documentation.dir}">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
    </target>
    
    <target name="copy-demo-scripts" description="Copy demo scripts">
        <copy todir="${dist.dir}/demo_scripts" overwrite="true" verbose="true">
            <fileset dir="${demo_scripts.dir}">
                <exclude name="readme.txt"/>
            </fileset>
        </copy>
    </target>
    
    <target name="dist-create" depends="dist-mkdir,unzip-jre,unzip-mysql,unzip-tomcat,update-conf-files,copy-database-data,copy-tools,copy-init-files,copy-documentation,copy-demo-scripts,copy-license" description="Copy necessary files on the distribution directory">
    </target>

    <target name="dist-create-webapps" depends="build-webapps,copy-webapps">
    </target>
    
    <target name="dist-start-mysqld" description="Starts the MySQL daemon">
        <exec dir="${dist.dir}/mysql/bin" executable="${dist.mysqld.path}" spawn="true">
            <arg value="--defaults-file=../my.ini"/>
        </exec>
        
        <echo>Sleeping for 10 seconds to allow the MySQL server to start</echo>
        <sleep seconds="10"/>
    </target>
    
    <target name="dist-stop-mysqld" description="Stop the MySQL daemon">
        <exec dir="${dist.dir}/mysql/bin" executable="${stop_mysql_script.path}" spawn="false">
        </exec>
        
        <echo>Sleeping for 5 seconds to allow the MySQL server to shutdown</echo>
        <sleep seconds="5"/>
    </target>
    
    <target name="dist-initialize-database" description="Initializes the database with necessary data based on the 'database' parameter.">
        <echo>Initializing with database: ${database}</echo>
        
        <!-- Create the central and local database -->
        <sql userid="root" password="" url="jdbc:mysql://localhost:13306/" driver="com.mysql.jdbc.Driver">
            DROP DATABASE IF EXISTS ibdb_${database}_central;
            CREATE DATABASE ibdb_${database}_central;
            
            DROP DATABASE IF EXISTS ibdb_${database}_local;
            CREATE DATABASE ibdb_${database}_local;
            
            GRANT ALL ON ibdb_${database}_central.* TO 'central'@'localhost' IDENTIFIED BY 'central';
            GRANT ALL ON ibdb_${database}_local.* TO 'local'@'localhost' IDENTIFIED BY 'local';
            FLUSH PRIVILEGES;
        </sql>
        
        <!-- Initialize the local database -->
        <foreach target="run_script_local" param="sqlFile">
            <path>
                <fileset dir="${IBDBScripts.dir}">
                    <include name="IBDBv1_DMS.sql"/>
                    <include name="IBDBv1_GMS-LOCAL.sql"/>
                    <include name="IBDBv1_IMS.sql"/>
                    <include name="IBDBv1_Workbench_Project.sql"/>
                </fileset>
                <fileset dir="${IBDBScripts.dir}">
                    <include name="IBDBv1_GDMS_User.sql"/>
                </fileset>
                <fileset dir="${crop.database.dir}/local/${database}">
                    <include name="**/*.sql"/>
                </fileset>
            </path>
        </foreach>

        <!-- Initialize the central database -->
        <foreach target="run_script_central" param="sqlFile">
            <path>
                <fileset dir="${crop.database.dir}/central/${database}">
                    <include name="**/*.sql"/>
                </fileset>
                <fileset dir="${IBDBScripts.dir}">
                    <include name="IBDBv1_GDMS_User.sql"/>
                </fileset>
            </path>
        </foreach>
    </target>
    
    <target name="run_script_central" description="Run SQL script on the local database">
        <exec dir="${dist.dir}/mysql/bin" executable="${run_script.path}" spawn="false">
            <arg value="${mysql.port}"/>
            <arg value="ibdb_${database}_central"/>
            <arg value="${sqlFile}"/>
        </exec>
    </target>
    
    <target name="run_script_local" description="Run SQL script on the central database">
        <exec dir="${dist.dir}/mysql/bin" executable="${run_script.path}" spawn="false">
            <arg value="${mysql.port}"/>
            <arg value="ibdb_${database}_local"/>
            <arg value="${sqlFile}"/>
        </exec>
    </target>
    
    <target name="dist-clean">
        <!-- TODO: We can actually stop any running workbench here by using the "taskkill" command -->
        
        <delete dir="${dist.dir}"/>
    </target>

    <target name="dist" depends="dist-clean, dist-mkdir, copy-jars, copy-images, dist-create" description="">
        <echo>Distribution directory created.</echo>
    </target>
    
    <target name="nsis" description="Copy NSIS files on the distribution directory in preparation for creating the installer">
        <delete file="${dist.dir}/ibpworkbench-win32.exe" failonerror="false"/>
        
        <copy todir="${dist.dir}">
            <fileset dir="${nsis.dir}"/>
        </copy>
        
        <exec dir="${dist.dir}" executable="${makensis.path}">
            <arg value="/P5"/>
            <arg value="install.nsi"/>
        </exec>
        
        <echo>The installer file is ${dist.dir}\ibpworkbench-win32.exe</echo>
    </target>
    
    <target name="make_installer" depends="dist, nsis" description="Build the distribution directory and create the installer">
    </target>
</project>
